name: æ­£å¼ç‰ˆæ„å»º

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # ------------ æå‰å‡†å¤‡ï¼ˆè¯»å–åŒ…å & ç‰ˆæœ¬å·ï¼‰ ------------
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      pkg: ${{ steps.pkg.outputs.pkg }}
      pkg_capitalized: ${{ steps.pkg_capitalized.outputs.pkg_capitalized }}
      version: ${{ steps.ver.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      mihomo_version: ${{ steps.get_mihomo_version.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: è¯»å– pubspec.yaml åŒ…å
        id: pkg
        run: |
          pkg=$(grep '^name:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” æ£€æµ‹åˆ°åŒ…å: $pkg"
          if [ -z "$pkg" ]; then
            echo "::error::æ— æ³•ä» pubspec.yaml æ‰¾åˆ°åŒ…å"
            exit 1
          fi
          echo "pkg=$pkg" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆé¦–å­—æ¯å¤§å†™çš„åŒ…å
        id: pkg_capitalized
        run: |
          pkg="${{ steps.pkg.outputs.pkg }}"
          # å°†é¦–å­—æ¯è½¬æ¢ä¸ºå¤§å†™
          first_char=$(echo "${pkg:0:1}" | tr '[:lower:]' '[:upper:]')
          rest="${pkg:1}"
          pkg_capitalized="${first_char}${rest}"
          echo "âœ¨ é¦–å­—æ¯å¤§å†™åŒ…å: $pkg_capitalized"
          echo "pkg_capitalized=$pkg_capitalized" >> $GITHUB_OUTPUT

      - name: è¯»å–æˆ–ç”Ÿæˆç‰ˆæœ¬å·
        id: ver
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            version="${{ github.event.inputs.version }}"
            echo "ğŸ“ æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $version"
          else
            raw=$(grep '^version:' pubspec.yaml | awk '{print $2}')
            version="${raw%%+*}"
            echo "ğŸ“¦ ä» pubspec.yaml è¯»å–ç‰ˆæœ¬: $version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ç¡®å®š Tag åç§°
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            tag="v${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            tag="${{ github.ref_name }}"
          else
            tag="v${{ steps.ver.outputs.version }}"
          fi
          echo "ğŸ·ï¸ Tag åç§°: $tag"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: è·å– Mihomo æ ¸å¿ƒç‰ˆæœ¬å·
        id: get_mihomo_version
        shell: pwsh
        run: |
          Write-Host "ğŸ“¡ æ­£åœ¨è·å– Mihomo æœ€æ–°ç‰ˆæœ¬å·..."
          try {
            $headers = @{
              "Accept" = "application/vnd.github+json"
              "X-GitHub-Api-Version" = "2022-11-28"
              "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            }
            $response = Invoke-RestMethod -Uri "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" -Headers $headers
            $version = $response.tag_name -replace '^v', ''
            Write-Host "âœ… Mihomo æœ€æ–°ç‰ˆæœ¬: $version"
            echo "version=$version" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "âš ï¸ æœªèƒ½è·å– Mihomo ç‰ˆæœ¬å·ï¼Œå°†ä½¿ç”¨ 'æœªçŸ¥'"
            echo "version=æœªçŸ¥" >> $env:GITHUB_OUTPUT
          }

      - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          tag_version="${{ steps.tag.outputs.tag }}"
          
          # ç§»é™¤ tag ä¸­çš„ 'v' å‰ç¼€
          tag_version_clean="${tag_version#v}"
          
          # å§‹ç»ˆä» pubspec.yaml è¯»å–å®é™…ç‰ˆæœ¬å·ï¼ˆä¸ä½¿ç”¨ç¼“å­˜çš„è¾“å‡ºï¼‰
          actual_pubspec_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          
          echo "ğŸ” ç‰ˆæœ¬å¯¹æ¯”ï¼š"
          echo "  Tag ç‰ˆæœ¬:           $tag_version_clean"
          echo "  pubspec.yaml ç‰ˆæœ¬:  $actual_pubspec_version"
          
          if [ "$tag_version_clean" != "$actual_pubspec_version" ]; then
            echo ""
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼"
            echo ""
            echo "æ¨é€çš„ tag ç‰ˆæœ¬ ($tag_version) ä¸ pubspec.yaml ä¸­çš„å®é™…ç‰ˆæœ¬ ($actual_pubspec_version) ä¸åŒ¹é…ã€‚"
            echo ""
            echo "è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š"
            echo "  1. æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬å·ä¸º $tag_version_clean"
            echo "  2. åˆ é™¤å½“å‰ tag å¹¶æ¨é€æ­£ç¡®çš„ tag: v$actual_pubspec_version"
            echo ""
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡"

  # ------------ æ„å»º jobï¼ˆä¾èµ– prepareï¼‰ ------------
  build:
    name: æ„å»º ${{ matrix.platform }}-${{ matrix.arch }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            arch: x64
    runs-on: ${{ matrix.os }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        shell: bash
        run: |
          echo "============================================"
          echo "ğŸ“¦ åŒ…å:        ${{ needs.prepare.outputs.pkg }}"
          echo "â« ç‰ˆæœ¬å·:      ${{ needs.prepare.outputs.version }}"
          echo "ğŸ·ï¸ Tag:         ${{ needs.prepare.outputs.tag }}"
          echo "ğŸ–¥ï¸ å¹³å°:        ${{ matrix.platform }}"
          echo "âš™ï¸ æ¶æ„:        ${{ matrix.arch }}"
          echo "============================================"

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ (matrix.os == 'windows-11-arm' || matrix.os == 'ubuntu-24.04-arm') && 'master' || 'stable' }}

      - name: é…ç½® Javaï¼ˆAndroidï¼‰
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        shell: bash
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
          if [ "$RUNNER_OS" = "Linux" ] && [ "${{ matrix.platform }}" != "android" ]; then
            echo "  â¤ å®‰è£… Linux æ„å»ºä¾èµ–..."
            sudo apt-get update
            sudo apt-get install -y libgtk-3-dev libappindicator3-dev adwaita-icon-theme-full libkeybinder-3.0-dev
            echo "  âœ… Linux ä¾èµ–å®‰è£…å®Œæˆ"
          fi
          echo "  â¤ å®‰è£… Flutter ä¸»é¡¹ç›®ä¾èµ–"
          flutter pub get
          echo "  â¤ å®‰è£… rinf_cli"
          cargo install rinf_cli
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£…é¢„æ„å»ºè„šæœ¬ä¾èµ–
        run: dart pub get
        working-directory: scripts

      - name: è¿è¡Œé¢„æ„å»ºè„šæœ¬
        shell: bash
        run: |
          ARGS=""
          if [ "${{ matrix.platform }}" = "android" ]; then
            ARGS="--android"
          else
            ARGS="--installer"
          fi
          dart run scripts/prebuild.dart $ARGS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: é…ç½® Android ç­¾å
        if: matrix.platform == 'android' && env.ANDROID_KEYSTORE_BASE64 != ''
        shell: bash
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > ${{ runner.temp }}/release.jks
          echo "ANDROID_KEYSTORE_PATH=${{ runner.temp }}/release.jks" >> $GITHUB_ENV
          echo "ANDROID_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> $GITHUB_ENV
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: è¿è¡Œæ„å»ºè„šæœ¬
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "android" ]; then
            ARGS="--android --android-arch=${{ matrix.arch }}"
          else
            ARGS="--with-installer"
          fi
          dart run scripts/build.dart $ARGS

      - name: å¤åˆ¶æ„å»ºäº§ç‰©åˆ° dist
        shell: bash
        run: |
          echo "ğŸ“¦ æ­£åœ¨å¤åˆ¶æ„å»ºäº§ç‰©..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            pwsh -c '
              New-Item -ItemType Directory -Force -Path dist | Out-Null
              if (Test-Path "build/packages") {
                Copy-Item -Path "build/packages/*" -Destination "dist/" -Recurse -Force
                Write-Host "âœ… æ„å»ºäº§ç‰©å·²å¤åˆ¶åˆ° dist/"
                Write-Host ""
                Write-Host "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
                Get-ChildItem -Path "dist/" | ForEach-Object {
                  $size = if ($_.PSIsContainer) { "ç›®å½•" } else { "$([math]::Round($_.Length / 1MB, 2)) MB" }
                  Write-Host "  - $($_.Name) ($size)"
                }
              } else {
                Write-Host "âŒ é”™è¯¯: build/packages ç›®å½•ä¸å­˜åœ¨"
                exit 1
              }
            '
          else
            mkdir -p dist
            if [ -d "build/packages" ]; then
              cp -r build/packages/* dist/
              echo "âœ… æ„å»ºäº§ç‰©å·²å¤åˆ¶åˆ° dist/"
              echo ""
              echo "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
              ls -lh dist/
            else
              echo "âŒ é”™è¯¯: build/packages ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.pkg }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 90
